<!DOCTYPE html>
<html>
<head>
	<title>MIDS Living Wage Explorer</title>

	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta charset="utf8">
	

	<link rel="stylesheet" href="lwc.css" />
	<link rel="stylesheet" href="tabs.css" />
	<link rel="stylesheet" href="selectric/selectric.css" />

	<style>
	/* Automatically generated from: Flaticon.woff 0.0 */

	@font-face {
		font-family: "Flaticon";
		src: url("icons/Flaticon.woff");
		font-weight: 500;
		font-stretch: normal;
		font-style: normal;
		unicode-range: U+20, U+F100-F108;
	}
	</style>
</head>

<body>
	<script src="jquery.min.js"></script>
	<script src="selectric/jquery.selectric.min.js"></script>

	<script src="d3.v3.js"></script>
	<script src="queue.v1.min.js"></script>
	<script src="topojson.v1.min.js"></script>
	<script src="d3.tip.v0.6.3.js"></script>
	<script src="d3-legend.min.js"></script>

	<script>
		// From; https://developer.mozilla.org/en-US/docs/Web/Events/resize
		;(function() {
		    var throttle = function(type, name, obj) {
		        obj = obj || window;
		        var running = false;
		        var func = function() {
		            if (running) { return; }
		            running = true;
		             requestAnimationFrame(function() {
		                obj.dispatchEvent(new CustomEvent(name));
		                running = false;
		            });
		        };
		        obj.addEventListener(type, func);
		    };

		    /* init - you can init any event */
		    throttle("resize", "optimizedResize");
		})();
	</script>

	<script src="map.js"></script>
	<script src="barchart.js"></script>

	<span style="font-family: Flaticon; position: absolute; top: -1000px; color: white;">&#xF100;</span>

	<div id="calculator">
		<div id="lwcContainer"></div>
		<div id="dataContainer">
			
			<div style="margin-bottom: 10px; margin-top: 15px;">
	
				<select id="modelSelect" disabled>
					<option value="mit_lwc">MIT Living Wage</option>
					<option value="mids_lwc" selected>MIDS Living Wage</option>
					<option value="4xTC">4x Current CTC &amp; EITC</option>
					<option value="medical">Bernie's Medicaid For All</option>
					<option value="UBI_12k">Universal Basic Income $12k</option>
					<option value="safety">Expanded Safety Net</option>
					<option value="daycare">Free Daycare</option>
				</select>

				<img class="fakeButton disabledButton" id="diffSwitch" src="plus.png"></img>
			</div>

			<div>
	
				<select id="familySelect" disabled>
					<option value="1Adult">1 Adult</option>
					<option value="1Adult1Child">1 Adult + 1 Child</option>
					<option value="1Adult2Child">1 Adult + 2 Children</option>
					<option value="1Adult3Child">1 Adult + 3 Children</option>
					<option value="2Adult">2 Adults</option>
					<option selected value="2Adult1Child">2 Adults + 1 Child</option>
					<option value="2Adult2Child">2 Adults + 2 Children</option>
					<option value="2Adult3Child">2 Adults + 3 Children</option>
				</select>
			</div>

			<div id="diffSelects" class="hidden">
				<div id="compareToDiv" style="color: grey">vs</div>
				<div id="diffModelSelectArea" style="margin-bottom: 10px;">

					<img class="fakeButton disabledButton" id="mainSwitch" src="minus.png"></img>
				</div>
				<div id="diffFamilySelectArea">

				</div>
			</div>

			<div id="countyNameContainer" class="hidden" style="margin-right: 15px;">
				<div id="countyName">&nbsp;</div>
				<div id="chartName"><span id="chartNameLW"></span></div>
			</div>

			<div id="mainDataArea" class="dataArea">
				<div id="mainInitialHolder" class="initialholder">
					<span>Click on a county to see a cost breakdown</span>
				</div>

				<div id="barchartContainer" class="hidden">
					<div id="costChart"></div>
				</div>
			</div>

			<div id="diffDataArea" class="dataArea hidden" style="margin-top: 20px;">
				<div id="diffInitialHolder" class="initialholder">
					<span>Click on a county to see a cost breakdown</span>
				</div>

				<div id="diffBarchartContainer" class="hidden">

					<div id="diffTabs" class="tabs tabs-style-linebox">
						<nav>
							<ul>
								<li><a href='#tab1Content'><span>Diff</span></a></li>
								<li><a href='#tab2Content'><span id="firstModelTab">First</span></a></li>
								<li><a href='#tab3Content'><span id="secondModelTab">Second</span></a></li>
							</ul>
						</nav>
					
						
						<div id="tab1Content"></div>

						<div id="tab2Content"></div>
						
						<div id="tab3Content"></div>
					</div>

				</div>
			</div>

			<div class="fakeMargin"></div>
		</div>

	</div>

	<script>
		var diffModelSelect = $('#modelSelect').clone()
		diffModelSelect.attr('id', 'diffModelSelect')

		var diffFamilySelect = $('#familySelect').clone()
		diffFamilySelect.attr('id', 'diffFamilySelect')

		
		diffModelSelect.prependTo($('#diffModelSelectArea'));
		diffFamilySelect.appendTo($('#diffFamilySelectArea'));

		diffMode = false;

		$(function(){
		  $('select').selectric();
		});

		function normalize_fips(fips) {
			if (fips[0] == '0') {
				return fips.substr(1);
			}

			return fips;
		}

		function enableBoxes() {
			$('#familySelect').attr('disabled', false).selectric('refresh');
			$('#modelSelect').attr('disabled', false).selectric('refresh');
			$('#diffModelSelect').attr('disabled', false).selectric('refresh');
			$('#diffFamilySelect').attr('disabled', false).selectric('refresh');

			$('#diffSwitch').removeClass('disabledButton');
			$('#mainSwitch').removeClass('disabledButton');
		}

		function disableBoxes() {
			$('#familySelect').attr('disabled', 'disabled').selectric('refresh');
			$('#modelSelect').attr('disabled', 'disabled').selectric('refresh');
			$('#diffModelSelect').attr('disabled', 'disabled').selectric('refresh');
			$('#diffFamilySelect').attr('disabled', 'disabled').selectric('refresh');

			$('#diffSwitch').addClass('disabledButton');
			$('#mainSwitch').addClass('disabledButton');
		}

		under_lw_map = {
			"mit_lwc" : "MIT Below LWC",
			"mids_lwc": "MIDS Below LWC",
			"4xTC" : "4xTC Below LWC",
			"medical": "Medical Below LWC",
			"UBI_12k": "UBI_12k Below LWC",
			"safety" :"Expanded Safety Net Below LWC",
			"daycare" : "Daycare Below LWC"
		}

		models = {
			"mit_lwc": {
				"housing": "Housing",
				"food": "Food",
				"childcare": "ChildCare",
				"transportation": "Transportation",
				"medical": "Medical",
				"other": "Other",
				"taxes": "Taxes",
				"benefits": "zero",
				"total": "MIT LWC"
			},

			"mids_lwc": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "MIDS Taxes",
				"benefits": "MIDS Benefits",
				"total": "MIDS LW"
			},
			"4xTC": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "4xTC Taxes",
				"benefits": "4xTC Benefits",
				"total": "4xTC LW"
			},
			"medical": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "Medical Tax",
				"benefits": "Medical Benefits",
				"total": "Medical LWC"
			},
			"UBI_12k": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "UBI_12k Tax",
				"benefits": "UBI_12k Benefits",
				"total": "UBI_12k LWC"
			},
			"safety": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "Expanded Safety Net Tax",
				"benefits": "Expanded Safety Net Benefits",
				"total": "Expanded Safety Net LWC"
			},
			"daycare": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "Daycare Tax",
				"benefits": "Daycare Benefits",
				"total": "Daycare LWC"
			},

		}

		family_data = {}

		lwcMap = UsMap; // want to make this a proper object at some point...

		rateById = d3.map();
		countyByFips = d3.map();

		currentFips = null;

		selectedFamily = document.getElementById('familySelect').value;
		secondSelectedFamily = selectedFamily;

		selectedModel = models[document.getElementById('modelSelect').value];
		
		var secondModelSelect = document.getElementById('diffModelSelect');
		secondModelSelect.value = secondModelSelect.options[0].value;
		secondSelectedModel = models[secondModelSelect.value];
		
		selectedData = d3.map();
		family_data[selectedFamily] = selectedData;

		modelColumns = d3.set();
		for (m in models) {
			var model = models[m];
			for (c in model) {
				modelColumns.add(model[c]);
			}
		}
		modelColumns = modelColumns.values();

		var processModelRow = function(row) {
			modelColumns.forEach(function(c) {
				var val = row[c];
				if (val === "#N/A") {
					val = 0;
				}else{
					val = +val;
				}
				row[c] = val;
			});
		}

		var processFamilyCsv = function(d) {

			var fips = normalize_fips(d['FIPS'])
			processModelRow(d);
			d['zero'] = 0;

			selectedData.set(fips, d);
			rateById.set(fips, d[selectedModel.total]);
				
		}

		var recalculateRateById = function() {
			rateById = d3.map();
			selectedData.entries().forEach(function(e) {
				var fips = e.key;
				var data = e.value;

				if (diffMode) {
					var firstTotal = data[selectedModel.total]
					var secondTotal = secondSelectedData.get(fips)[secondSelectedModel.total]

					rateById.set(fips, firstTotal - secondTotal);
				}else{
					rateById.set(fips, data[selectedModel.total]);
				}
			});
		}

		var updateGraphs = function() {

			lwcMap.recolor(rateById);

			if (chartShown) {
				updateBarcharts(currentFips);
			}
		}

		var lwFormat = d3.format("$,.02f");

		var updateChartHeights = function() {
			if (diffMode) {
				var tabHeight = d3.select('#diffTabs > nav').node().getBoundingClientRect().height;
				var offset = tabHeight + 15;

				firstBarChart.setSize(document.getElementById('diffDataArea').getBoundingClientRect().height - offset)
				secondBarChart.setSize(document.getElementById('diffDataArea').getBoundingClientRect().height - offset)
				diffBarChart.setSize(document.getElementById('diffDataArea').getBoundingClientRect().height - offset)
			}else{
				mainBarChart.setSize(document.getElementById('mainDataArea').getBoundingClientRect().height - 15)
			}
		};

		var updateBarcharts = function(fips) {

			updateChartHeights();

			var dataRow = selectedData.get(fips);
			var lwValue = 0;

			if (dataRow) {

				if (diffMode) {

					var secondDataRow = secondSelectedData.get(fips);

					var diffDataRow = {"FIPS": fips}
					var diffModel = {}

					var allValues = [];

					for (var element in selectedModel) {
						var first = dataRow[selectedModel[element]];
						var second = secondDataRow[secondSelectedModel[element]];
						var diff = first - second;

						diffDataRow[element] = diff;
						diffModel[element] = element;

						if (element !== "total") {
							allValues.push(first);
							allValues.push(second);
							allValues.push(diff);
						}
					}

					var yRange = [d3.min(allValues), d3.max(allValues)];

					console.dir(yRange);

					diffBarChart.update(diffModel, diffDataRow, yRange);
					firstBarChart.update(selectedModel, dataRow, yRange);
					secondBarChart.update(secondSelectedModel, secondDataRow, yRange);

					lwValue = lwFormat(diffDataRow['total']);

				}else{

					mainBarChart.update(selectedModel, dataRow);
					lwValue = getLWForFips(fips);
				}

				var county = countyByFips.get(fips);
				var countyText = county.name + ", " + county.state;
				document.getElementById('countyName').innerHTML = countyText;

				document.getElementById('chartNameLW').innerHTML = lwValue;

			}
		}

		var changeFamily = function(newFamily) {

			selectedFamily = newFamily;
			selectedData = family_data[selectedFamily];
			
			if (selectedData) {
				recalculateRateById();
				updateGraphs();
			} else {
				disableBoxes();

				selectedData = d3.map();
				rateById = d3.map();

				queue().defer(d3.csv, familyDataFile(selectedFamily), processFamilyCsv).await(function(error) {
					updateGraphs();

					family_data[selectedFamily] = selectedData;

					enableBoxes();
				});
			}
		}

		var changeSecondFamily = function(newFamily) {

			secondSelectedFamily = newFamily;
			secondSelectedData = family_data[secondSelectedFamily];
			
			if (secondSelectedData) {
				recalculateRateById();
				updateGraphs();
			} else {
				disableBoxes();

				secondSelectedData = d3.map();
				rateById = d3.map();

				queue().defer(d3.csv, familyDataFile(secondSelectedFamily), function(d) {

					var fips = normalize_fips(d['FIPS'])
					processModelRow(d);
					d['zero'] = 0;

					secondSelectedData.set(fips, d);

					var firstTotal = selectedData.get(fips)[selectedModel.total];
					var secondTotal = d[secondSelectedModel.total];

					rateById.set(fips, firstTotal - secondTotal);

				}).await(function(error) {
					updateGraphs();

					family_data[secondSelectedFamily] = secondSelectedData;

					enableBoxes();
				});
			}
		}

		var changeModel = function(newModel) {
			selectedModel = models[newModel];

			recalculateRateById();
			updateGraphs();
		}

		var changeSecondModel = function(newModel) {
			secondSelectedModel = models[newModel];

			recalculateRateById();
			updateGraphs();
		}

		var familyDataFile = function(family) {
			return "data/" + family + ".csv";
		}
		
		var dataDeferred = 
			queue()
			.defer(d3.csv, familyDataFile(selectedFamily), processFamilyCsv)
			.defer(d3.csv, "data/county_names.csv", function(d) {
				
				countyByFips.set(d['code'], {
					'state': d['state'], 
					'name': d['name']
				});

			})

		lwcMap = new UsMap(document.getElementById('lwcContainer'), function() {
			// This stuff is to handle race conditions between loading the csv and the map initialization.
			dataDeferred.await(function(error) {
				if (error) throw error;
				console.log("data loaded");

				lwcMap.recolor(rateById);

				enableBoxes();
			});
		});

		getLWForFips = function(fips) {
			var dataRow = selectedData.get(fips);
			var lw = dataRow[selectedModel.total];

			return lwFormat(lw);
		}

		var underlwFormat = d3.format("%");
		getUnderLW = function(data, model_id) {
			if (data) {
				var underLWCColumn = under_lw_map[model_id];
				if (underLWCColumn) {
					return underlwFormat(data[underLWCColumn]);
				}
			}

			return undefined;
		} 

		lwcMap.addTooltipHandler(function(d) {

			var fips = d.id;
			
			var county = countyByFips.get(fips);

			var tip = '<span class="ttCounty">' + county.name + "</span><br />";

			var firstModel = $('#modelSelect').val();

			var underLW = getUnderLW(selectedData.get(fips), firstModel)
			
			if (diffMode) {

				var secondModel = $('#diffModelSelect').val();

				if (selectedData.has(fips) && secondSelectedData.has(fips)) {

					var firstLW = selectedData.get(fips)[selectedModel.total];
					var secondLW = secondSelectedData.get(fips)[secondSelectedModel.total];

					var diffUnderLW = getUnderLW(secondSelectedData.get(fips), secondModel);

					var diffLW = lwFormat(firstLW - secondLW);

					tip += '<span class="ttDiffLW">Diff of LW: ' + diffLW + '</span><br />' +
						
						'<span>First LW: ' + lwFormat(firstLW) + '</span><br />' +
						'<span class="ttFirst">' + ((underLW !== undefined) ? 'Under LW: ' + underLW  : '&nbsp;') + '</span><br />' +

						"<span>Second LW: " + lwFormat(secondLW) + '</span><br />';

						if (diffUnderLW !== undefined)
							tip += '<span>Under LW: ' + diffUnderLW + '</span>';

					return tip;
				} else {
					return tip + "Apologies, Missing Data";
				}

			} else {

				if (selectedData.has(fips)) {
					tip += "<span>Living Wage: " + getLWForFips(fips) + '</span><br />';

					if (underLW !== undefined) {
						tip += '<span>Under LW: ' + underLW + '</span>';
					}

					return tip;
				} else {
					return tip + "Apologies, Missing Data";
				}

			}
		});

		var mainBarChart = new barchart(d3.select('#costChart'));

		var chartShown = false;

		// Hacky way to connect mouseover events to barchart
		lwcMap.overCounty = function(d) {
			var fips = d.id;
			currentFips = fips;
			
			if (!chartShown) {
				chartShown = true;

				d3.selectAll('.initialholder').remove();
				document.getElementById('countyNameContainer').className = '';				
				document.getElementById('barchartContainer').className = '';
				document.getElementById('diffBarchartContainer').className = '';
			}

			updateBarcharts(fips);
		}

		$('#familySelect').on('change', function(e) {
			changeFamily(e.target.value);
		});

		$('#modelSelect').on('change', function(e) {
			changeModel(e.target.value);
		});

		$('#diffFamilySelect').on('change', function(e) {
			changeSecondFamily(e.target.value);
		});

		$('#diffModelSelect').on('change', function(e) {
			changeSecondModel(e.target.value);
		});

		$('#diffSwitch').on('click', function(e) {
			var thisButton = $(this);
			if (thisButton.hasClass('disabledButton')) {
				return;
			}

			diffMode = true;
			// disabled attr is cloned, so remove it here
			$('#diffModelSelect').attr('disabled', false).selectric('refresh');
			$('#diffFamilySelect').attr('disabled', false).selectric('refresh');
			$('#diffDataArea').removeClass('hidden')
			$('#diffSelects').removeClass('hidden');

			$('#mainDataArea').addClass('hidden')

			thisButton.addClass('hidden');

			secondSelectedData = family_data[secondSelectedFamily];
			recalculateRateById();
			updateGraphs();
		});

		$('#mainSwitch').on('click', function(e) {

			var thisButton = $(this);
			if (thisButton.hasClass('disabledButton')) {
				return;
			}

			diffMode = false;

			$('#diffDataArea').addClass('hidden')
			$('#diffSelects').addClass('hidden');

			$('#mainDataArea').removeClass('hidden')

			$('#diffSwitch').removeClass('hidden');

			recalculateRateById();
			updateGraphs();
		});

		var diffBarchartHeight = 325;

		var diffBarChart = new barchart(d3.select('#tab1Content'), diffBarchartHeight);
		var firstBarChart = new barchart(d3.select('#tab2Content'), diffBarchartHeight);
		var secondBarChart = new barchart(d3.select('#tab3Content'), diffBarchartHeight);

		window.addEventListener("optimizedResize", function() {
			updateChartHeights();

			if (diffMode) {
				diffBarChart.draw();
				firstBarChart.draw();
				secondBarChart.draw();
			}else{
				mainBarChart.draw();
			}
		});				
	</script>
	<script src="tabs.js"></script>
</body>
</html>