<!DOCTYPE html>

<head>
	<title>Living Wage Calculator</title>

	<meta charset="utf8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="lwc.css" />
	<link rel="stylesheet" href="selectric/selectric.css" />

	<style>
	/* Automatically generated from: Flaticon.woff 0.0 */

	@font-face {
		font-family: "Flaticon";
		src: url("icons/Flaticon.woff");
		font-weight: 500;
		font-stretch: normal;
		font-style: normal;
		unicode-range: U+20, U+F100-F108;
	}
	</style>
</head>

<body>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="selectric/jquery.selectric.min.js"></script>

	<script src="//d3js.org/d3.v3.min.js"></script>
	<script src="//d3js.org/queue.v1.min.js"></script>
	<script src="//d3js.org/topojson.v1.min.js"></script>
	<script src="//labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.9.0/d3-legend.min.js"></script>

	<script src="map.js"></script>
	<script src="barchart.js"></script>

	<span style="font-family: Flaticon; position: absolute; top: -1000px; color: white;">&#xF100;</span>

<!--
	<span id ="chars" style="font-family: Flaticon; position: absolute;"></span>
	<script>
		var span = document.getElementById('chars');

		var charsList = '';
		
		for (var i = 0; i <= 8; i++) {
			charsList += '&#xF10' + i + " ";
		}

		span.innerHTML = charsList;
	</script>
-->
	<div id="calculator">
		<div id="lwcContainer"></div>
		<div id="dataContainer">
			<div style="margin-bottom: 10px;">
	
				<select id="modelSelect" disabled>
					<option value="mit_lwc">MIT LWC</option>
					<option value="mids_lwc" selected>MIDS LWC</option>
					<option value="3x_eitc">3x EITC</option>
					<option value="basic_income">Basic Income</option>
					<option value="mids_lwc_alt">MIDS LWC (Alternate)</option>
				</select>

			</div>

			<div>
	
				<select id="familySelect" disabled>
					<option selected value="1Adult">1 Adult</option>
					<option value="1Adult1Child">1 Adult + 1 Child</option>
					<option value="1Adult2Child">1 Adult + 2 Children</option>
					<option value="1Adult3Child">1 Adult + 3 Children</option>
					<option value="2Adult">2 Adults</option>
					<option value="2Adult1Child">2 Adults + 1 Child</option>
					<option value="2Adult2Child">2 Adults + 2 Children</option>
					<option value="2Adult3Child">2 Adults + 3 Children</option>
				</select>
			</div>

			<div id="barchartContainer" class="hidden">
				<div id="countyNameContainer">
					<div id="countyName">&nbsp;</div>
					<div id="chartName">Breakdown of <span id="chartNameLW"></span></div>
				</div>

				<div id="costChart"></div>
			</div>

			<div id="initialBarchartHolder">
				<span>Click on a county to see a cost breakdown</span>
			</div>

		</div>
	</div>

	<script>
		$(function(){
		  $('select').selectric();
		});

		function normalize_fips(fips) {
			if (fips[0] == '0') {
				return fips.substr(1);
			}

			if (fips.endsWith('99999')) {
				return fips.substring(0, fips.length - 5);
			}

			return fips;
		}

		function enableBoxes() {
			$('#familySelect').attr('disabled', false).selectric('refresh');
			$('#modelSelect').attr('disabled', false).selectric('refresh');
		}

		function disableBoxes() {
			$('#familySelect').attr('disabled', 'disabled').selectric('refresh');
			$('#modelSelect').attr('disabled', 'disabled').selectric('refresh');
		}

		models = {
			"mit_lwc": {
				"housing": "Housing",
				"food": "Food",
				"childcare": "ChildCare",
				"transportation": "Transportation",
				"medical": "Medical",
				"other": "Other",
				"taxes": "Taxes",
				"total": "MIT LWC"
			},

			"mids_lwc": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "MIDS Taxes All",
				"total": "MIDS LWC"
			},

			"3x_eitc": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "3x EITC Tax",
				"total": "3x EITC"
			},

			"basic_income": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "Basic Income Tax",
				"total": "Basic Income"
			},

			"mids_lwc_alt": {
				"housing": "Housing",
				"food": "MIDS Food",
				"childcare": "MIDS ChildCare",
				"transportation": "MIDS Transportation",
				"medical": "MIDS Medical",
				"other": "Other",
				"taxes": "MIDS Taxes Universal",
				"total": "MIDS LWC 2"
			}
		}

		family_data = {}

		lwcMap = UsMap; // want to make this a proper object at some point...

		rateById = d3.map();
		countyByFips = d3.map();
		salaryById = d3.map();
		percentUnderLivingWageById = d3.map();

		currentFips = null;

		salary_columns = ['10000', '15000', '20000', '25000', '30000', '35000', '40000', '45000', '50000', '60000', '75000', '100000', '125000', '150000', '200000', '200000+'];

		salary_buckets = salary_columns.slice(0, salary_columns.length - 1).map(function(s) {
			return parseInt(s);
		});

		var percentUnderLivingWage = function(fips) {
			if (percentUnderLivingWageById.has(fips)) {
				return percentUnderLivingWageById.get(fips);
			}else {
				var sb = salary_buckets;

				var lw = selectedData.get(fips)[selectedModel.total];
				var d = salaryById.get(fips);

				var peopleBelowLW = 0;
				var totalPeople = 0;
				var lastBucketIndexBelow = 0;

				for (var i = 0; i < salary_columns.length; i++) {
					var peopleInBucket = +d[salary_columns[i]];
					if (lw > salary_buckets[i]) {
						peopleBelowLW += peopleInBucket;
						lastBucketIndexBelow = i;
					}

					totalPeople += peopleInBucket;
				}

				var percentBelow = 1;

				if (lastBucketIndexBelow < salary_buckets.length) {

					// Interpolate between lastBucketIndexBelow and lastBucketIndexBelow + 1
					// to approximate how many people are below the living wage.
					var lowerSalary = salary_buckets[lastBucketIndexBelow];
					var upperSalary = salary_buckets[lastBucketIndexBelow + 1];
					var percentOfBucket = (lw - lowerSalary) / (upperSalary - lowerSalary);

					peopleBelowLW += +d[salary_columns[lastBucketIndexBelow + 1]] * percentOfBucket;

					percentBelow = peopleBelowLW / totalPeople;
				}

				percentUnderLivingWageById.set(fips, percentBelow * 100);
				return percentBelow * 100;
			}
		}

		selectedFamily = document.getElementById('familySelect').value;
		selectedModel = models[document.getElementById('modelSelect').value];
		
		selectedData = d3.map();
		family_data[selectedFamily] = selectedData;

		modelColumns = d3.set();
		for (m in models) {
			var model = models[m];
			for (c in model) {
				modelColumns.add(model[c]);
			}
		}
		modelColumns = modelColumns.values();

		var processModelRow = function(row) {
			modelColumns.forEach(function(c) {
				var val = row[c];
				if (val === "#N/A") {
					val = 0;
				}else{
					val = +val;
				}
				row[c] = val;
			});
		}

		var processFamilyCsv = function(d) {

			var fips = normalize_fips(d['FIPS'])
			processModelRow(d);

			selectedData.set(fips, d);
			rateById.set(fips, d[selectedModel.total]);
				
		}

		var recalculateRateById = function() {
			rateById = d3.map();
			selectedData.entries().forEach(function(e) {
				var fips = e.key;
				var data = e.value;

				rateById.set(fips, data[selectedModel.total]);
			});
		}

		var updateGraphs = function() {
			percentUnderLivingWageById = d3.map();

			lwcMap.recolor(rateById);

			if (currentFips) {
				mainBarChart.update(selectedModel, selectedData.get(currentFips));
			}
		}

		var changeFamily = function(newFamily) {

			selectedFamily = newFamily;
			selectedData = family_data[selectedFamily];
			
			percentUnderLivingWageById = d3.map();

			if (selectedData) {
				recalculateRateById();
				updateGraphs();
			} else {
				disableBoxes();

				selectedData = d3.map();
				rateById = d3.map();

				queue().defer(d3.csv, familyDataFile(), processFamilyCsv).await(function(error) {
					updateGraphs();

					family_data[selectedFamily] = selectedData;

					enableBoxes();
				});
			}
		}

		var changeModel = function(newModel) {
			selectedModel = models[newModel];

			recalculateRateById();
			updateGraphs();
		}

		var familyDataFile = function() {
			return "data/" + selectedFamily + ".csv";
		}
		
		var dataDeferred = 
			queue()
			.defer(d3.csv, familyDataFile(), processFamilyCsv)
			.defer(d3.csv, "data/county_names.csv", function(d) {
				
				countyByFips.set(d['code'], {
					'state': d['state'], 
					'name': d['name']
				});

			}).defer(d3.csv, "data/IncomeAndPop.csv", function(d) {

				var fips = normalize_fips(d['fips'])
				salaryById.set(fips, d);
			})

		lwcMap = new UsMap(document.getElementById('lwcContainer'), function() {
			// This stuff is to handle race conditions between loading the csv and the map initialization.
			dataDeferred.await(function(error) {
				if (error) throw error;
				console.log("data loaded");

				lwcMap.recolor(rateById);

				enableBoxes();
			});
		});

		var lwFormat = d3.format("$,.02");

		getLWForFips = function(fips) {
			var dataRow = selectedData.get(fips);
			var lw = dataRow[selectedModel.total];

			return lwFormat(lw);
		}

		lwcMap.addTooltipHandler(function(d) {
			
			var county = countyByFips.get(d.id);

			var tip = "<span>" + county.name + "</span><br />";
			
			if (selectedData.has(d.id)) {
				return tip +
					"<span>Living Wage: " + getLWForFips(d.id) + '</span><br />' +
					'<span>Under LW: ~' + (percentUnderLivingWage(d.id)).toFixed(2) + '%</span>';
			} else {
				return tip + "Apologies, Missing Data";
			}
		});

		var mainBarChart = new barchart(d3.select('#costChart'));

		var chartShown = false;

		// Hacky way to connect mouseover events to barchart
		lwcMap.overCounty = function(d) {
			var fips = d.id;
			currentFips = fips;
			var dataRow = selectedData.get(fips);

			if (dataRow) {

				mainBarChart.update(selectedModel, dataRow);

				var county = countyByFips.get(fips);
				var countyText = county.name + ", " + county.state;
				document.getElementById('countyName').innerHTML = countyText;

				document.getElementById('chartNameLW').innerHTML = getLWForFips(fips);
			}

			if (!chartShown) {
				chartShown = true;

				var ibhDiv = document.getElementById('initialBarchartHolder');
				ibhDiv.parentElement.removeChild(ibhDiv);

				document.getElementById('barchartContainer').className = '';
			}
		}

		$('#familySelect').on('change', function(e) {
			changeFamily(e.target.value);
		});

		$('#modelSelect').on('change', function(e) {
			changeModel(e.target.value);
		});
	</script>
</body>